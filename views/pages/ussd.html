<!-- USSD Services Page -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
        <h2 class="mb-1">
            <i class="bi bi-telephone-forward me-2"></i>USSD Services
        </h2>
        <p class="text-muted mb-0">Configure and access your custom USSD services</p>
    </div>
    <button class="btn btn-outline-primary" onclick="refreshUssdData()">
        <i class="bi bi-arrow-repeat"></i> Refresh
    </button>
</div>

<!-- USSD Tabs -->
<ul class="nav nav-tabs nav-fill mb-4" id="ussdTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="dial-tab" data-bs-toggle="tab" data-bs-target="#dial" type="button">
            <i class="bi bi-dialpad me-2"></i>Dial USSD
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="quick-tab" data-bs-toggle="tab" data-bs-target="#quick" type="button">
            <i class="bi bi-lightning-charge me-2"></i>Quick Services
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">
            <i class="bi bi-gear me-2"></i>Configure Services
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">
            <i class="bi bi-clock-history me-2"></i>History
        </button>
    </li>
</ul>

<div class="tab-content">
    <!-- ==================== DIAL USSD TAB ==================== -->
    <div class="tab-pane fade show active" id="dial" role="tabpanel">
        <div class="row g-4">
            <!-- USSD Dialer -->
            <div class="col-12 col-lg-5">
                <div class="card">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">
                            <i class="bi bi-dialpad me-2"></i>USSD Dialer
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label fw-bold">Enter USSD Code</label>
                            <div class="input-group input-group-lg">
                                <input type="text" class="form-control text-center" id="ussdCode" 
                                       placeholder="*123#" value="*123#">
                                <button class="btn btn-primary" type="button" onclick="sendUSSD()">
                                    <i class="bi bi-send"></i> Send
                                </button>
                            </div>
                            <small class="text-muted">Enter any USSD code (e.g., *123#, #100#, *101#)</small>
                        </div>

                        <!-- Quick Code Suggestions from Settings -->
                        <div class="mb-3">
                            <label class="fw-bold mb-2">Quick Codes:</label>
                            <div class="d-flex flex-wrap gap-2" id="quickCodeSuggestions">
                                <!-- Populated by JavaScript -->
                                <span class="text-muted">Loading...</span>
                            </div>
                        </div>

                        <!-- Recent Codes -->
                        <div>
                            <label class="fw-bold mb-2">Recent Codes:</label>
                            <div class="list-group" id="recentCodes">
                                <!-- Populated by JavaScript -->
                                <div class="list-group-item text-muted">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- USSD Response -->
            <div class="col-12 col-lg-7">
                <div class="card h-100">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-chat-dots me-2"></i>USSD Response
                        </h5>
                        <div>
                            <span class="badge bg-info me-2" id="sessionStatus">No Active Session</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="endSession()" id="endSessionBtn" style="display: none;">
                                <i class="bi bi-x-circle"></i> End Session
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="bg-light p-4 rounded" id="ussdResponse" style="min-height: 200px; font-family: monospace; white-space: pre-wrap;">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-arrow-up-circle fs-1 d-block mb-3"></i>
                                <p>Enter a USSD code to see response</p>
                            </div>
                        </div>

                        <!-- Menu Navigation (for interactive USSD) -->
                        <div id="menuNavigation" class="mt-3" style="display: none;">
                            <label class="fw-bold mb-2">Choose Option:</label>
                            <div class="d-flex flex-wrap gap-2" id="menuOptions">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== QUICK SERVICES TAB ==================== -->
    <div class="tab-pane fade" id="quick" role="tabpanel">
        <div class="row g-4" id="quickServicesGrid">
            <!-- Dynamically populated from settings -->
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SETTINGS TAB ==================== -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
        <div class="row g-4">
            <!-- Service List -->
            <div class="col-12 col-lg-8">
                <div class="card">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>Configured Services
                        </h5>
                        <button class="btn btn-sm btn-primary" onclick="showAddServiceModal()">
                            <i class="bi bi-plus"></i> Add Service
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 50px">#</th>
                                        <th>Service</th>
                                        <th>USSD Code</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th style="width: 120px">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="servicesTable" class="sortable">
                                    <!-- Populated by JavaScript -->
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="col-12 col-lg-4">
                <div class="card">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>How to Configure
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex align-items-center">
                                <span class="badge bg-primary rounded-circle me-3">1</span>
                                Add your custom USSD services
                            </div>
                            <div class="list-group-item d-flex align-items-center">
                                <span class="badge bg-primary rounded-circle me-3">2</span>
                                Drag <i class="bi bi-grip-vertical mx-2"></i> to reorder
                            </div>
                            <div class="list-group-item d-flex align-items-center">
                                <span class="badge bg-primary rounded-circle me-3">3</span>
                                Toggle switch to enable/disable
                            </div>
                            <div class="list-group-item d-flex align-items-center">
                                <span class="badge bg-primary rounded-circle me-3">4</span>
                                Edit codes anytime
                            </div>
                        </div>

                        <hr>

                        <h6 class="fw-bold">Example Codes:</h6>
                        <ul class="small">
                            <li><code>*123#</code> - Balance check</li>
                            <li><code>*456#</code> - Data balance</li>
                            <li><code>#100#</code> - Call forwarding</li>
                            <li><code>*101#</code> - Own number</li>
                            <li><code>611</code> - Customer care</li>
                            <li><code>*500#</code> - Offers</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== HISTORY TAB ==================== -->
    <div class="tab-pane fade" id="history" role="tabpanel">
        <div class="card">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>USSD History
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearHistory()">
                        <i class="bi bi-trash"></i> Clear All
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive d-none d-md-block">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date & Time</th>
                                <th>Code</th>
                                <th>Description</th>
                                <th>Response</th>
                                <th style="width: 100px">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <!-- Populated by JavaScript -->
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile view -->
                <div class="d-block d-md-none" id="historyMobile">
                    <!-- Populated by JavaScript -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
            
            <!-- Pagination -->
            <div class="card-footer bg-white py-3">
                <nav>
                    <ul class="pagination pagination-sm justify-content-center mb-0" id="historyPagination">
                        <!-- Populated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Service Modal -->
<div class="modal fade" id="serviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serviceModalTitle">
                    <i class="bi bi-plus-circle me-2"></i>Add Service
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="serviceForm" onsubmit="return false;">
                    <input type="hidden" id="serviceKey">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Service Key *</label>
                        <input type="text" class="form-control" id="serviceKeyInput" 
                               placeholder="e.g., mybalance, special-offer" 
                               pattern="[a-z0-9-]+" 
                               title="Lowercase letters, numbers, and hyphens only">
                        <small class="text-muted">Unique identifier (lowercase, no spaces) - cannot be changed after creation</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Service Name *</label>
                        <input type="text" class="form-control" id="serviceNameInput" 
                               placeholder="e.g., Check Balance">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">USSD Code *</label>
                        <input type="text" class="form-control" id="ussdCodeInput" 
                               placeholder="e.g., *123#" 
                               pattern="^[*#0-9]+$"
                               title="Only numbers, *, and # allowed">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Description</label>
                        <textarea class="form-control" id="descriptionInput" rows="2" 
                                  placeholder="Brief description of this service"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Icon</label>
                        <select class="form-select" id="iconInput">
                            <option value="cash-stack">üí∞ Balance</option>
                            <option value="wifi">üì∂ Data</option>
                            <option value="telephone">üìû Minutes</option>
                            <option value="chat-dots">üí¨ SMS</option>
                            <option value="gift">üéÅ Offers</option>
                            <option value="box">üì¶ Packages</option>
                            <option value="headset">üéß Support</option>
                            <option value="phone">üì± Own Number</option>
                            <option value="star">‚≠ê FNF</option>
                            <option value="arrow-left-right">‚ÜîÔ∏è MNP</option>
                            <option value="question">‚ùì Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enabledInput" checked>
                        <label class="form-check-label" for="enabledInput">Enable this service</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteServiceBtn" style="display: none;">Delete</button>
                <button type="button" class="btn btn-primary" onclick="saveService()">Save Service</button>
            </div>
        </div>
    </div>
</div>

<!-- USSD Response Modal -->
<div class="modal fade" id="ussdResponseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-chat-dots me-2"></i>USSD Response
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="bg-light p-4 rounded" id="modalResponse" style="white-space: pre-wrap; font-family: monospace;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyResponse()">
                    <i class="bi bi-files"></i> Copy
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Load USSD script -->
<script src="/js/ussd.js"></script>

<style>
.cursor-pointer {
    cursor: pointer;
}

.service-card {
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
    height: 100%;
}

.service-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    border-color: #0d6efd;
}

.badge {
    cursor: pointer;
}

#ussdResponse {
    font-size: 1.1rem;
    line-height: 1.6;
}

.menu-option {
    min-width: 60px;
    text-align: center;
}

.sortable tr {
    cursor: grab;
}

.sortable tr:active {
    cursor: grabbing;
    opacity: 0.8;
}

.drag-handle {
    cursor: grab;
    font-size: 1.2rem;
    color: #6c757d;
}

.drag-handle:active {
    cursor: grabbing;
}

@media (max-width: 767.98px) {
    .service-card {
        margin-bottom: 1rem;
    }
    
    #ussdResponse {
        font-size: 1rem;
    }
}
</style>